<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Viewer – Load Test</title>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #2c2f38;
    color: #e0e0e0;
    padding: 20px;
}

.media-container {
    margin-bottom: 35px;
}

.media-number {
    font-size: 11px;
    opacity: 0.6;
    margin-bottom: 4px;
}

.load-method {
    font-size: 10px;
    opacity: 0.5;
    margin-bottom: 6px;
}

.media-container img {
    max-width: 100%;
    max-height: 70vh;
    border-radius: 10px;
}

.media-container a {
    display: block;
    word-break: break-all;
    text-decoration: none;
    color: #00aaff;
    font-size: 12px;
    margin-top: 6px;
}

button {
    padding: 10px 20px;
    margin: 5px;
    cursor: pointer;
    font-size: 15px;
    border: none;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
}

.back-btn {
    font-size: 10px;
    padding: 2px 6px;
    opacity: 0.4;
    background-color: #666;
}
</style>
</head>

<body>

<h1>Media Viewer – Twitter Load Test</h1>

<div id="topControls"></div>
<div id="mediaContainer"></div>
<div id="bottomControls"></div>

<script>
const PAGE_SIZE = 20;
let mediaUrls = [];
let workingList = [];
let currentIndex = 0;

/* ---------- HELPERS ---------- */

function snapToTop() {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
}

function isTwitter(url) {
    return url.includes("pbs.twimg.com/media/");
}

function controlsHTML() {
    return `
        <button class="back-btn" onclick="prevPage()">←</button>
        <button onclick="nextPage()">Next ${PAGE_SIZE}</button>
    `;
}

function renderControls() {
    topControls.innerHTML = controlsHTML();
    bottomControls.innerHTML = controlsHTML();
}

function nextPage() {
    render();
    snapToTop();
}

function prevPage() {
    currentIndex = Math.max(0, currentIndex - PAGE_SIZE * 2);
    render();
    snapToTop();
}

/* ---------- IMAGE LOAD TEST ---------- */

function createTestImage(url, labelEl) {
    const attempts = [
        {
            name: "direct",
            src: url,
            setup: img => {}
        },
        {
            name: "no-referrer",
            src: url,
            setup: img => img.referrerPolicy = "no-referrer"
        },
        {
            name: "cors-anon",
            src: url,
            setup: img => img.crossOrigin = "anonymous"
        },
        {
            name: "weserv",
            src: "https://images.weserv.nl/?url=" + encodeURIComponent(url.replace(/^https?:\/\//, "")),
            setup: img => {}
        },
        {
            name: "weserv-jpg",
            src: "https://images.weserv.nl/?output=jpg&url=" + encodeURIComponent(url.replace(/^https?:\/\//, "")),
            setup: img => {}
        },
        {
            name: "weserv-resize",
            src: "https://images.weserv.nl/?w=1200&url=" + encodeURIComponent(url.replace(/^https?:\/\//, "")),
            setup: img => {}
        }
    ];

    let attemptIndex = 0;

    const img = document.createElement("img");
    img.loading = "lazy";
    img.decoding = "async";

    function tryNext() {
        if (attemptIndex >= attempts.length) {
            labelEl.textContent = "❌ failed all methods";
            return;
        }

        const attempt = attempts[attemptIndex++];
        img.onload = () => {
            labelEl.textContent = `loaded via: ${attempt.name}`;
        };
        img.onerror = () => {
            tryNext();
        };

        attempt.setup(img);
        img.src = attempt.src;
    }

    tryNext();
    return img;
}

/* ---------- RENDER ---------- */

function render() {
    renderControls();
    mediaContainer.innerHTML = "";

    for (let i = 0; i < PAGE_SIZE && currentIndex < workingList.length; i++) {
        const item = workingList[currentIndex];
        const wrapper = document.createElement("div");
        wrapper.className = "media-container";

        const num = document.createElement("div");
        num.className = "media-number";
        num.textContent = `#${item.index}`;
        wrapper.appendChild(num);

        const label = document.createElement("div");
        label.className = "load-method";
        label.textContent = "loading…";
        wrapper.appendChild(label);

        if (isTwitter(item.url)) {
            const img = createTestImage(item.url, label);
            wrapper.appendChild(img);
        }

        const link = document.createElement("a");
        link.href = item.url;
        link.target = "_blank";
        link.textContent = item.url;
        wrapper.appendChild(link);

        mediaContainer.appendChild(wrapper);
        currentIndex++;
    }
}

/* ---------- INIT ---------- */

fetch("media.json")
    .then(r => r.json())
    .then(data => {
        mediaUrls = data;
        workingList = mediaUrls.map((url, i) => ({ url, index: i + 1 }));
        render();
    });
</script>

</body>
</html>
